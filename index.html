<!DOCTYPE html><html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#000000"/>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<title>Ajanda</title>
<style>
:root{
  --bg:#000;
  --panel:rgba(16,16,16,.72);
  --edge:#1a1a1a;
  --ink:#eef2f7;
  --muted:#97a1b3;
  --tint:#5aa8ff;
  --radius:18px;
  --tabh:68px;
  --fs-h1:clamp(20px,4.8vw,28px);
  --fs-h2:clamp(18px,3.8vw,22px);
  --fs-title:clamp(15px,2.9vw,18px);
  --fs-body:clamp(14px,2.2vw,16px);
  --fs-cap:12px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; background:#000; color:var(--ink);
  font:600 var(--fs-body)/1.58 -apple-system, ui-sans-serif, system-ui, "SF Pro Text", Inter, "Helvetica Neue";
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  padding-bottom:calc(var(--tabh) + env(safe-area-inset-bottom) + 10px);
}
body.noscroll{overflow:hidden}
.bgfx{position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.85;
  background:
    radial-gradient(1200px 800px at 80% 8%, rgba(90,168,255,.22), transparent 60%),
    radial-gradient(900px 700px at 15% 28%, rgba(168,85,247,.18), transparent 60%);
}

/* layout */
.container{position:relative; z-index:1; max-width:960px; margin:0 auto; padding:calc(6px + env(safe-area-inset-top)) 12px 0}
.header{position:sticky; top:0; z-index:20; display:flex; align-items:center; justify-content:center; gap:10px;
  background:rgba(0,0,0,.35); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
  padding:12px 10px; border-bottom:1px solid var(--edge);
}
.brand{font-size:var(--fs-h1); font-weight:900; letter-spacing:.2px}
.beam{position:absolute; right:14px; top:50%; transform:translateY(-50%); width:18px; height:18px; border-radius:999px; border:1px solid rgba(255,255,255,.06);
  background:radial-gradient(circle at 50% 50%, rgba(250,204,21,1) 0%, rgba(250,204,21,.25) 60%, transparent 70%);
  box-shadow:0 0 18px rgba(250,204,21,.6);
}
.card{background:var(--panel); border:1px solid var(--edge); border-radius:var(--radius); padding:14px; margin-top:12px; box-shadow:0 10px 40px rgba(0,0,0,.45); backdrop-filter:blur(18px)}
.title{font-size:var(--fs-title); font-weight:800; letter-spacing:.2px}
.sub{color:var(--muted); font-size:var(--fs-cap)}
.hr{height:1px;background:#121212;margin:8px 0}

.dayline{font-size:var(--fs-h2); font-weight:900; text-align:center}
.month-head{display:flex; align-items:center; justify-content:space-between}
.cal-toggle{cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--edge); border-radius:12px; background:rgba(12,12,12,.5)}
.grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
.weekday{color:var(--muted); text-align:center; font-size:var(--fs-cap); font-weight:700}
.d{aspect-ratio:1/1; display:grid; place-items:center; border:1px solid var(--edge); border-radius:12px; background:rgba(13,13,13,.65); font-weight:900; cursor:pointer; font-size:14px}
.d.muted{opacity:.45}.d.sel{outline:2px solid var(--tint); outline-offset:-3px}.d.today{border-color:#2b2b2b}
.collapsible{overflow:hidden; transition:max-height .25s ease, opacity .2s ease; opacity:0; max-height:0}.collapsible.open{opacity:1; max-height:1000px}

.list{display:grid; gap:10px}
.item{background:rgba(16,16,16,.62); border:1px solid var(--edge); border-radius:14px; padding:12px}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

.btn,input,select,textarea{appearance:none; border:1px solid var(--edge); background:rgba(16,16,16,.62); color:var(--ink); padding:10px 12px; border-radius:12px; font-weight:700}
.btn.primary{background:linear-gradient(180deg,#183022,#101a15); border-color:#254232}
.btn:active{transform:translateY(1px)}

.dot{width:10px;height:10px;border-radius:50%;background:var(--tint);margin-top:7px}
.dot.ok{background:#22c55e}.dot.note{background:#a78bfa}.dot.bad{background:#ef4444}
.timeline .event{display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start}
.ev-title{font-weight:800}

#map{height:58vh;border-radius:14px;overflow:hidden;border:1px solid var(--edge);background:rgba(10,10,10,.7)}

/* tab bar */
.tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabh);padding-bottom:env(safe-area-inset-bottom);background:rgba(6,6,6,.54);border-top:1px solid var(--edge);display:grid;grid-template-columns:repeat(5,1fr);z-index:60;backdrop-filter:blur(18px)}
.tabbtn{display:grid;place-items:center;gap:4px;color:#8893a6;font-size:12px;text-decoration:none}.tabbtn.active{color:var(--ink)}.tabbtn svg{width:22px;height:22px;fill:currentColor}.tabbtn.center svg{width:28px;height:28px}

/* pages */
.page{display:none}.page.active{display:block}
.pad-bottom{height:calc(var(--tabh) + env(safe-area-inset-bottom) + 20px)}

/* speed dial */
.dial-overlay{position:fixed; inset:0; background:rgba(0,0,0,.25); backdrop-filter:blur(3px); display:none; z-index:65}
.dial-overlay.open{display:block}
.dial{position:fixed; display:flex; gap:12px; z-index:66}
.mini{width:56px;height:56px;border-radius:16px;border:1px solid var(--edge);background:rgba(16,16,16,.7);display:grid;place-items:center;box-shadow:0 10px 28px rgba(0,0,0,.45);transform:scale(.9);opacity:0;transition:transform .18s ease,opacity .18s ease}
.mini.show{transform:scale(1);opacity:1}
.mini svg{width:26px;height:26px;fill:var(--ink)}

/* full-screen composer */
.modal{position:fixed; inset:0; z-index:1000; display:none}
.modal.open{display:block}
.scrim{position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(8px)}
.sheet{position:absolute; left:0; right:0; bottom:0; top:0; padding:calc(10px + env(safe-area-inset-top)) 12px calc(var(--tabh) + env(safe-area-inset-bottom) + 12px);
  display:grid; grid-template-rows:auto 1fr auto; gap:12px}
.sheet .head{display:flex; justify-content:space-between; align-items:center}
.sheet .seg{display:flex; gap:8px}
.segment{padding:8px 12px; border:1px solid var(--edge); background:rgba(16,16,16,.62); border-radius:999px; font-weight:800}
.segment.active{outline:2px solid var(--tint); outline-offset:-2px}
.sheet .panel{background:var(--panel); border:1px solid var(--edge); border-radius:18px; padding:14px; overflow:auto}
.field{display:grid; gap:6px; margin-bottom:12px}
.field label{font-size:12px; color:var(--muted); font-weight:700}
.actions{display:flex; gap:10px; justify-content:flex-end}
</style>
</head>
<body>
<div class="bgfx"></div>
<div class="container">
  <header class="header">
    <div class="brand">Ajanda</div>
    <div class="beam" title="Durum"></div>
  </header>

  <main id="pg-home" class="page active">
    <section class="card center">
      <div class="dayline" id="dayLine">—</div>
    </section>

    <section class="card">
      <div class="month-head">
        <div class="title" id="monthLabel">—</div>
        <button id="calToggle" class="cal-toggle" aria-expanded="false">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="#a1a8b4"><path d="M7 2h2v2h6V2h2v2h3a2 2 0 012 2v3H2V6a2 2 0 012-2h3V2zm15 8v10a2 2 0 01-2 2H4a2 2 0 01-2-2V10h20z"/></svg>
          <span class="sub">Takvimi aç</span>
        </button>
      </div>
      <div id="calWrap" class="collapsible">
        <div class="row" style="justify-content:space-between; margin-top:8px">
          <button class="btn" id="prevMonth">‹</button>
          <div class="sub">Ay seç</div>
          <button class="btn" id="nextMonth">›</button>
        </div>
        <div class="grid" id="calWeekdays" style="margin-top:8px"></div>
        <div class="grid" id="calGrid"></div>
      </div>
    </section>

    <section class="card">
      <div class="title">Günün Zaman Çizelgesi</div>
      <div class="list timeline" id="timelineList"></div>
    </section>

    <div class="pad-bottom"></div>
  </main>

  <main id="pg-map" class="page">
    <section class="card">
      <div class="title">Harita</div>
      <div class="sub">Kayıtlı konumları gör</div>
      <div class="hr"></div>
      <div id="map"></div>
    </section>
    <div class="pad-bottom"></div>
  </main>

  <main id="pg-search" class="page">
    <section class="card">
      <div class="title">Ara</div>
      <div class="row">
        <input id="q" class="btn" placeholder="kelime, kişi, adres…"/>
        <button id="searchBtn" class="btn">Ara</button>
      </div>
      <div class="hr"></div>
      <div class="list" id="searchResults"></div>
    </section>
    <div class="pad-bottom"></div>
  </main>

  <main id="pg-settings" class="page">
    <section class="card">
      <div class="title">Veri</div>
      <div class="row">
        <button id="exportBtn" class="btn">CSV indir</button>
        <label for="importFile" class="btn" style="cursor:pointer">İçe Aktar</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="clearBtn" class="btn">Tümünü Temizle</button>
      </div>
    </section>
    <div class="pad-bottom"></div>
  </main>
</div>

<!-- Tab Bar -->
<nav class="tabbar">
  <a class="tabbtn active" data-tab="home" aria-label="Ana Menü">
    <svg viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
  </a>
  <a class="tabbtn" data-tab="map" aria-label="Harita">
    <svg viewBox="0 0 24 24"><path d="M9 3l6 2 6-2v18l-6 2-6-2-6 2V5l6-2zm0 2.2L5 6v12l4-1.8V5.2zm2 0v14l4 1.4V6.6L11 5.2zm10 0l-4 1.4v12l4-1.8V5.2z"/></svg>
  </a>
  <a id="addTab" class="tabbtn center" data-tab="add" aria-label="Ekle">
    <svg viewBox="0 0 24 24"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
  </a>
  <a class="tabbtn" data-tab="search" aria-label="Arama">
    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.8l-.3-.3a6.5 6.5 0 10-.7.7l.3.3v.8l5 5 1.5-1.5-5-5zm-6 0A4.5 4.5 0 1114 9.5 4.5 4.5 0 019.5 14z"/></svg>
  </a>
  <a class="tabbtn" data-tab="settings" aria-label="Ayarlar">
    <svg viewBox="0 0 24 24"><path d="M19.14 12.94a7.48 7.48 0 000-1.88l2.03-1.58a.5.5 0 00.12-.64l-1.92-3.32a.5.5 0 00-.6-.22l-2.39.96a7.52 7.52 0 00-1.63-.94l-.36-2.54a.5.5 0 00-.5-.42h-3.84a.5.5 0 00-.5.42l-.36 2.54a7.52 7.52 0 00-1.63.94l-2.39-.96a.5.5 0 00-.6.22L2.71 8.84a.5.5 0 00.12.64l2.03 1.58a7.48 7.48 0 000 1.88l-2.03 1.58a.5.5 0 00-.12.64l1.92 3.32a.5.5 0 00.6.22l2.39-.96c.5.38 1.05.69 1.63.94l.36 2.54a.5.5 0 00.5.42h3.84a.5.5 0 00.5-.42l.36-2.54c.58-.25 1.13-.56 1.63-.94l2.39.96a.5.5 0 00.6-.22l1.92-3.32a.5.5 0 00-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1115.5 12 3.5 3.5 0 0112 15.5z"/></svg>
  </a>
</nav>

<!-- Speed Dial -->
<div id="dialOverlay" class="dial-overlay"></div>
<div id="dial" class="dial" style="display:none">
  <button id="miniNote" class="mini" title="Not">
    <svg viewBox="0 0 24 24"><path d="M6 2h9l5 5v15a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2zm8 1.5V8h4.5L14 3.5zM7 12h10v2H7v-2zm0 4h10v2H7v-2zm0-8h6v2H7V8z"/></svg>
  </button>
  <button id="miniCall" class="mini" title="Çağrı">
    <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.56.57 1 1 0 011 1v3.61a1 1 0 01-1 1A17 17 0 013 5a1 1 0 011-1h3.61a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.24 1.01l-2.32 2.22z"/></svg>
  </button>
  <button id="miniPlace" class="mini" title="Konum">
    <svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 112.5-2.5 2.5 2.5 0 01-2.5 2.5z"/></svg>
  </button>
</div>

<!-- Full-screen Composer -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="scrim"></div>
  <div class="sheet">
    <div class="head">
      <div class="seg" id="modeSeg">
        <button data-m="note" class="segment active">Not</button>
        <button data-m="call" class="segment">Çağrı</button>
        <button data-m="place" class="segment">Konum</button>
      </div>
      <div class="seg">
        <button id="cancelBtn" class="segment">Vazgeç</button>
        <button id="saveBtn" class="segment" style="background:linear-gradient(180deg,#183022,#101a15); border-color:#254232">Kaydet</button>
      </div>
    </div>
    <div class="panel" id="formPanel"></div>
    <div class="sub" style="text-align:right">Saat: <span id="nowTxt">—</span></div>
  </div>
</div>

<script>
// basic utils
const $=(q)=>document.querySelector(q), $$=(q)=>Array.from(document.querySelectorAll(q));
function haptic(ms=15){ if(navigator.vibrate){ navigator.vibrate(ms) } }
const fmt=(t)=> new Date(t).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
const dayLong=(ts)=> new Date(ts).toLocaleDateString('tr-TR',{day:'2-digit',month:'long',weekday:'long'});
const startDay=(ts)=>{const d=new Date(ts);d.setHours(0,0,0,0);return d.getTime()}; const endDay=(ts)=>{const d=new Date(ts);d.setHours(23,59,59,999);return d.getTime()};
const todayKey=()=> new Date().toISOString().slice(0,10);

// state & storage
const Store={key:'agenda.v9.1', data:{notes:[],calls:[],places:[],addrCache:{}},
  load(){const raw=localStorage.getItem(this.key); if(raw){this.data=JSON.parse(raw)}; renderAll()},
  save(){localStorage.setItem(this.key, JSON.stringify(this.data))}
};

// pages & tabs
const pages={home:$('#pg-home'),map:$('#pg-map'),search:$('#pg-search'),settings:$('#pg-settings')};
const tabs=$$('.tabbtn');
function showTab(name){ Object.values(pages).forEach(p=>p.classList.remove('active')); (pages[name]||pages.home).classList.add('active'); tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===name)); if(name==='map'){setTimeout(initMapOnce,80); setTimeout(()=>{if(window._map)window._map.invalidateSize(); updateMap()},160)} }
tabs.forEach(t=>t.addEventListener('click',(e)=>{ const tab=t.dataset.tab; if(tab==='add'){ e.preventDefault(); openDial(); return } haptic(8); showTab(tab) }));
showTab('home');

// day & calendar
let selectedDay=todayKey();
function setDay(ts){ $('#dayLine').textContent=dayLong(ts) }
setDay(Date.now());
const weekdays=['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
function buildCal(){ const w=$('#calWeekdays'); w.innerHTML=''; weekdays.forEach(x=>{const d=document.createElement('div'); d.className='weekday'; d.textContent=x; w.appendChild(d)}); }
function daysInMonth(y,m){return new Date(y,m+1,0).getDate()} function firstWeekday(y,m){const d=new Date(y,m,1).getDay(); return (d+6)%7}
let cy=new Date().getFullYear(), cm=new Date().getMonth();
function renderCalendar(){ $('#monthLabel').textContent=new Date(cy,cm,1).toLocaleDateString('tr-TR',{month:'long',year:'numeric'}); const grid=$('#calGrid'); grid.innerHTML=''; const days=daysInMonth(cy,cm), off=firstWeekday(cy,cm), prev=daysInMonth(cy,cm-1);
  for(let i=0;i<off;i++)grid.appendChild(cell(prev-off+i+1,true));
  for(let d=1; d<=days; d++)grid.appendChild(cell(d,false));
  const left=42-(off+days); for(let d=1; d<=left; d++)grid.appendChild(cell(d,true,true));
  highlightSel();
}
function cell(day,muted,next=false){
  const el=document.createElement('div'); el.className='d'+(muted?' muted':''); el.textContent=day;
  let y=cy,m=cm; if(muted && !next){m--; if(m<0){m=11;y--}} if(muted && next){m++; if(m>11){m=0;y++}}
  const key=`${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; if(key===todayKey()) el.classList.add('today'); el.dataset.key=key;
  el.onclick=()=>{selectedDay=key; setDay(new Date(key)); highlightSel(); renderAll(); haptic(6)}; return el;
}
function highlightSel(){ $$('#calGrid .d').forEach(d=>d.classList.toggle('sel', d.dataset.key===selectedDay)) }
$('#prevMonth').onclick=()=>{cm--; if(cm<0){cm=11;cy--} renderCalendar(); haptic(6)}; $('#nextMonth').onclick=()=>{cm++; if(cm>11){cm=0;cy++} renderCalendar(); haptic(6)};
buildCal(); renderCalendar();
const wrap=$('#calWrap'); const togg=$('#calToggle'); function setCal(open){wrap.classList.toggle('open',open); togg.querySelector('span').textContent=open?'Takvimi gizle':'Takvimi aç'; togg.setAttribute('aria-expanded',open)}; setCal(false);
togg.onclick=()=>{ setCal(!wrap.classList.contains('open')); haptic(8) };

// timeline
function renderTimeline(){
  const list=$('#timelineList'); list.innerHTML='';
  const base=new Date(selectedDay+'T00:00:00').getTime(); const from=startDay(base), to=endDay(base);
  const evs=[];
  for(const n of Store.data.notes){ if(n.ts>=from&&n.ts<=to) evs.push({type:'note', sort:n.ts, ts:n.ts, title:n.title||'', text:n.text}) }
  for(const c of Store.data.calls){ if(c.ts>=from&&c.ts<=to) evs.push({type:'call', sort:c.ts+0.1, ts:c.ts, who:c.who, callType:c.type, notes:c.notes}) }
  for(const p of Store.data.places){ if(p.ts>=from&&p.ts<=to) evs.push({type:'place', sort:p.ts+0.2, ts:p.ts, name:p.name, addr:p.addr}) }
  evs.sort((a,b)=>a.sort-b.sort);
  if(!evs.length){ const empty=document.createElement('div'); empty.className='item'; empty.innerHTML='<div class="sub">Bu gün için kayıt yok.</div>'; list.appendChild(empty); return }
  const chunk=30; let i=0;
  function draw(){ for(let k=0;k<chunk && i<evs.length;k++,i++){ const e=evs[i]; const el=document.createElement('div'); el.className='item timeline event'; el.dataset.id=e.id;
      const dot = e.type==='place'?'ok': e.type==='call'?(e.callType==='cevapsız'?'bad':'') : 'note';
      const title = e.type==='place' ? 'Konum' : e.type==='call' ? (e.callType==='giden'?'Giden':e.callType==='cevapsız'?'Cevapsız':'Gelen')+' arama' : (e.title? e.title+' — ':'')+'Not';
      const sub = e.type==='place' ? (e.name ? e.name+' • ' : '')+(e.addr||'') : e.type==='call' ? [e.who||'Bilinmeyen', e.notes||''].filter(Boolean).join(' • ') : e.text;
      el.innerHTML=`<div class="dot ${dot}"></div><div><div class="ev-title">${fmt(e.ts)} — ${title}</div><div class="sub">${sub||''}</div></div>`;
      el.onclick=()=>openEditor(e);
      list.appendChild(el); } if(i<evs.length){ (window.requestIdleCallback||setTimeout)(draw,50) } }
  draw();
}
function renderAll(){ renderTimeline(); if(window._map) updateMap() }
setInterval(()=>$('#dayLine').textContent=dayLong(Date.now()),60*1000);

// editor (full-screen modal)
const modal=$('#modal'), formPanel=$('#formPanel'), nowTxt=$('#nowTxt');
let mode='note';
function openModal(m){ mode=m; document.body.classList.add('noscroll'); modal.classList.add('open'); buildForm(mode); nowTxt.textContent=fmt(Date.now()); modal.setAttribute('aria-hidden','false') }
function closeModal(){ modal.classList.remove('open'); document.body.classList.remove('noscroll'); modal.setAttribute('aria-hidden','true') }
$('#cancelBtn').onclick=closeModal;
$('#modeSeg').addEventListener('click',(e)=>{const btn=e.target.closest('.segment'); if(!btn) return; $$('#modeSeg .segment').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); mode=btn.dataset.m; buildForm(mode) });

function buildForm(m){
  formPanel.innerHTML='';
  if(m==='note'){
    formPanel.innerHTML=`
      <div class="field"><label>Başlık (opsiyonel)</label><input id="f_title" class="btn" placeholder="Başlık"></div>
      <div class="field"><label>Not</label><textarea id="f_text" rows="6" class="btn" placeholder="Bugün olanlar…"></textarea></div>
      <div class="field"><label>Etiketler (virgülle)</label><input id="f_tags" class="btn" placeholder="iş, spor, aile"></div>`;
  } else if(m==='call'){
    formPanel.innerHTML=`
      <div class="field"><label>Kişi</label><input id="f_who" class="btn" placeholder="Kişi adı"></div>
      <div class="field"><label>Tür</label>
        <div class="row"><button class="btn" data-t="gelen">Gelen</button><button class="btn" data-t="giden">Giden</button><button class="btn" data-t="cevapsız">Cevapsız</button></div>
        <input id="f_type" value="gelen" hidden/>
      </div>
      <div class="field"><label>Not (opsiyonel)</label><textarea id="f_notes" rows="4" class="btn" placeholder="Detay…"></textarea></div>`;
    formPanel.querySelectorAll('.field .btn[data-t]').forEach(b=>b.onclick=()=>{formPanel.querySelectorAll('.field .btn[data-t]').forEach(x=>x.style.outline=''); b.style.outline='2px solid var(--tint)'; $('#f_type').value=b.dataset.t});
  } else {
    formPanel.innerHTML=`
      <div class="field"><label>Yer adı</label><input id="p_name" class="btn" placeholder="örn. Ev, İş, Kafe"></div>
      <div class="field"><label>Adres</label><input id="p_addr" class="btn" placeholder="Cadde, No, İlçe…"></div>
      <div class="field"><button id="pickMap" class="btn">Haritada seç</button><div class="sub" id="pickHint">Enlem/Boylam: —</div></div>`;
    $('#pickMap').onclick=openPicker;
  }
}

$('#saveBtn').onclick=()=>{
  const ts=Date.now();
  if(mode==='note'){
    const text=$('#f_text').value.trim(); const title=$('#f_title').value.trim(); const tags=$('#f_tags').value;
    if(!text){alert('Not boş olamaz'); return}
    Store.data.notes.push({ts,text,title,tags});
  } else if(mode==='call'){
    const who=$('#f_who').value.trim(); const type=$('#f_type').value; const notes=$('#f_notes').value;
    if(!who && type!=='cevapsız'){alert('Kişi?'); return}
    Store.data.calls.push({ts,who,type,notes});
  } else {
    const name=$('#p_name').value.trim(); const addr=$('#p_addr').value.trim(); const lat=window._pickLat||null; const lon=window._pickLon||null;
    if(!name && !addr){alert('En azından isim ya da adres gir.'); return}
    Store.data.places.push({ts,name,addr,lat,lon});
  }
  Store.save(); closeModal(); renderAll();
};

// speed dial
const dial=$('#dial'), dialOv=$('#dialOverlay'), addBtn=$('#addTab');
function openDial(){
  const r=addBtn.getBoundingClientRect(); const y=Math.round(r.top - 80); const x=Math.round(r.left + r.width/2);
  dial.style.left=(x - 56*1.5 - 10)+'px'; dial.style.top=y+'px'; dial.style.display='flex'; dialOv.classList.add('open');
  setTimeout(()=>{$$('#dial .mini').forEach(m=>m.classList.add('show'))},10);
}
function closeDial(){ $$('#dial .mini').forEach(m=>m.classList.remove('show')); setTimeout(()=>{dial.style.display='none'; dialOv.classList.remove('open')},160) }
dialOv.addEventListener('click',closeDial);
$('#miniNote').onclick=()=>{closeDial(); openModal('note')}
$('#miniCall').onclick=()=>{closeDial(); openModal('call')}
$('#miniPlace').onclick=()=>{closeDial(); openModal('place')}

// map (view & picker)
function initMapOnce(){
  if(window._map) return;
  window._map=L.map('map',{zoomControl:true}).setView([39.93,32.86],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(window._map);
  window._placesLayer=L.layerGroup().addTo(window._map);
  updateMap();
}
function updateMap(){
  if(!window._map) return;
  window._placesLayer.clearLayers();
  const pts=[];
  for(const p of Store.data.places){ if(p.lat && p.lon){ const m=L.marker([p.lat,p.lon]).addTo(window._placesLayer); m.bindPopup((p.name||'Konum')+'<br/>'+(p.addr||'')); pts.push([p.lat,p.lon]); } }
  if(pts.length) window._map.fitBounds(pts,{padding:[20,20]});
}
function openPicker(){
  // open small overlay map picker
  const ov=document.createElement('div'); ov.style.cssText='position:fixed;inset:0;z-index:1200;background:rgba(0,0,0,.55)';
  const wrap=document.createElement('div'); wrap.style.cssText='position:absolute;left:12px;right:12px;top:calc(10px + env(safe-area-inset-top));bottom:calc(var(--tabh) + env(safe-area-inset-bottom) + 12px);background:#0a0a0a;border:1px solid var(--edge);border-radius:18px;overflow:hidden';
  const mapdiv=document.createElement('div'); mapdiv.id='pickMapDiv'; mapdiv.style.cssText='position:absolute;inset:0';
  wrap.appendChild(mapdiv); ov.appendChild(wrap); document.body.appendChild(ov);
  const mp=L.map('pickMapDiv').setView([39.93,32.86],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mp);
  let marker=null;
  function setLatLng(latlng){ if(marker) marker.setLatLng(latlng); else marker=L.marker(latlng,{draggable:true}).addTo(mp); window._pickLat=latlng.lat; window._pickLon=latlng.lng; $('#pickHint').textContent='Enlem/Boylam: '+latlng.lat.toFixed(5)+', '+latlng.lng.toFixed(5) }
  mp.on('click',e=>setLatLng(e.latlng));
  const btn=document.createElement('button'); btn.textContent='Seç'; btn.className='btn'; btn.style.cssText='position:absolute;right:12px;bottom:12px;z-index:10';
  btn.onclick=()=>{document.body.removeChild(ov)}; wrap.appendChild(btn);
}

// search
$('#searchBtn').onclick=()=>{
  const q=($('#q').value||'').toLowerCase(); const out=$('#searchResults'); out.innerHTML='';
  function push(title,sub){const el=document.createElement('div'); el.className='item'; el.innerHTML='<div class="title">'+title+'</div><div class="sub">'+(sub||'')+'</div>'; out.appendChild(el)}
  Store.data.notes.forEach(n=>{const txt=((n.title||'')+' '+n.text+' '+(n.tags||'')).toLowerCase(); if(!q||txt.includes(q)) push('Not — '+new Date(n.ts).toLocaleDateString('tr-TR'), (n.title? n.title+' • ':'')+n.text)});
  Store.data.calls.forEach(c=>{const txt=((c.who||'')+' '+(c.notes||'')+' '+(c.type||'')).toLowerCase(); if(!q||txt.includes(q)) push((c.type==='giden'?'Giden':c.type==='cevapsız'?'Cevapsız':'Gelen')+' arama', (c.who||'Bilinmeyen')+(c.notes?' • '+c.notes:''))});
  Store.data.places.forEach(p=>{const txt=((p.name||'')+' '+(p.addr||'')).toLowerCase(); if(!q||txt.includes(q)) push('Konum', (p.name? p.name+' • ':'')+(p.addr||''))});
  if(!out.children.length) out.innerHTML='<div class="sub">Sonuç yok</div>';
};

// export / import
document.getElementById('exportBtn').onclick=()=>{
  const rows=[['time','type','title','details']];
  function add(t,ty,ti,de){rows.push([new Date(t).toISOString(),ty,ti,de])}
  Store.data.notes.forEach(n=>add(n.ts,'note',n.title||'Not',n.text||''));
  Store.data.calls.forEach(c=>add(c.ts,'call',c.type,(c.who||'')+' '+(c.notes||'')));
  Store.data.places.forEach(p=>add(p.ts,'place',p.name||'Konum',(p.addr||'')+' '+(p.lat? (p.lat+','+p.lon):'')));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ajanda.csv'; a.click();
};
document.getElementById('importFile').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader();
  rd.onload=()=>{try{const obj=JSON.parse(rd.result); if(obj && (obj.notes||obj.calls||obj.places)){ Store.data=obj; Store.save(); renderAll() }}catch{alert('Hatalı dosya')}};
  rd.readAsText(f);
};
document.getElementById('clearBtn').onclick=()=>{ if(confirm('Tüm verileri sil?')){ localStorage.removeItem(Store.key); Store.data={notes:[],calls:[],places:[],addrCache:{}}; renderAll() } };

// init
Store.load();
setInterval(()=>setDay(Date.now()),60*1000);

// service worker
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{})})}
</script>
</body></html>
