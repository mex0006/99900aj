<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <meta name="theme-color" content="#0b0c0f"/>
  <title>Ajanda — Kişisel Zaman Çizelgesi</title>
  <style>
    :root{ --bg:#0b0c0f; --panel:#12151a; --ink:#eaeef2; --muted:#a0a8b6; --edge:#202733; --pill:#161b22; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --brand:#60a5fa; --radius:18px;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0a0c10,#0d1016 60%,#0a0c10); color:var(--ink);
         font:500 15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
         -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
         display:flex; align-items:center; justify-content:center; padding:14px}
    .app{width:min(860px,100%); background:var(--panel); border:1px solid var(--edge); border-radius:24px; padding:14px;
         box-shadow:0 12px 36px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03)}
    header{display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--pill); border:1px solid var(--edge); border-radius:20px}
    .logo{font-weight:800; letter-spacing:.2px} .muted{color:var(--muted)} .spacer{flex:1}
    .wrap{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px} @media (max-width:820px){ .wrap{grid-template-columns:1fr} }
    .card{background:#0e1318; border:1px solid var(--edge); border-radius:20px; padding:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button,input,select{appearance:none; border:1px solid var(--edge); background:var(--pill); color:var(--ink); padding:10px 12px; border-radius:12px; font-weight:700}
    button{cursor:pointer; transition:transform .06s ease} button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#1b2a1e,#142116); border-color:#233524}
    .danger{background:linear-gradient(180deg,#2a1b1b,#211414); border-color:#312121}
    .ok{background:linear-gradient(180deg,#1a2330,#141a22); border-color:#263041}
    .list{display:grid; gap:10px} .item{background:var(--pill); border:1px solid var(--edge); border-radius:16px; padding:12px}
    .title{font-weight:800} .badge{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--edge); font-size:12px; color:var(--muted)}
    .k{font-size:12px; color:var(--muted)} .v{font-weight:800}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px} .hr{height:1px; background:linear-gradient(90deg,transparent,#1e2630,transparent); margin:8px 0}
    .pill{background:#0b1016; border:1px solid var(--edge); border-radius:999px; padding:8px 10px}
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
           background:#0e1318; color:var(--ink); border:1px solid var(--edge); border-radius:999px; padding:10px 14px; font-size:14px;
           box-shadow:0 8px 24px rgba(0,0,0,.4); opacity:0; pointer-events:none; transition:opacity .25s ease}
    .toast.show{opacity:1} .hint{font-size:12px; color:var(--muted)} .tag{font-size:12px; color:#cbd5e1; background:#0c1116; border:1px solid var(--edge); padding:6px 8px; border-radius:999px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Ajanda — Kişisel Zaman Çizelgesi">
    <header>
      <div class="logo">🗓️ Ajanda</div>
      <div class="pill" id="statusPill">Durum: <b id="statusText">Hazır</b></div>
      <div class="pill">Bugün: <b id="dayText">—</b></div>
      <div class="spacer"></div>
      <button id="installHint" class="ok" title="Ana Ekrana Ekle talimatı">Ana Ekrana</button>
      <button id="exportBtn" class="ok">Dışa Aktar</button>
      <label for="importFile" class="ok" style="cursor:pointer">İçe Aktar</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="clearBtn" class="danger">Temizle</button>
    </header>

    <div class="wrap">
      <section class="card" aria-label="Takip ve Hızlı Ekle">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">Konum Takibi</div>
            <div class="hint">Bu web uygulaması açık kaldıkça konumunu izler ve <b>kalış</b> (visit) noktaları oluşturur. iOS, tarayıcı arka plandayken izlemeyi kısıtlayabilir.</div>
          </div>
          <div class="row">
            <button id="toggleBtn" class="primary">Takibi Başlat</button>
            <select id="accuracySel" title="Hassasiyet">
              <option value="balanced">Dengeli</option>
              <option value="high">Yüksek</option>
              <option value="low">Düşük</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="grid2">
          <div class="item">
            <div class="k">Son Konum</div>
            <div class="v" id="lastFix">—</div>
            <div class="mono" id="lastCoords"></div>
          </div>
          <div class="item">
            <div class="k">Kalış Algılama</div>
            <div>Yarıçap <input id="radiusInp" type="number" min="30" max="300" step="10" value="120" style="width:80px"> m · Eşik <input id="dwellInp" type="number" min="3" max="60" step="1" value="8" style="width:70px"> dk</div>
            <div class="hint">Bir noktada <b>yarıçap</b> içinde <b>eşik</b> süreden fazla kalırsan, kalış (visit) oluşur.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row" style="gap:8px">
          <button id="noteBtn">Hızlı Not</button>
          <button id="callBtn">Arama Ekle</button>
          <span class="hint">Not ve aramalar cihazında saklanır.</span>
        </div>
      </section>

      <section class="card" aria-label="Özet">
        <div class="title">Bugünün Özeti</div>
        <div class="list" id="summaryList" style="margin-top:8px"></div>
      </section>

      <section class="card" aria-label="Kalışlar (Visits)">
        <div class="title">Kalışlar</div>
        <div class="list" id="visitsList" style="margin-top:8px"></div>
      </section>

      <section class="card" aria-label="Aramalar ve Notlar">
        <div class="title">Aramalar & Notlar</div>
        <div class="list" id="callsList" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="list" id="notesList"></div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ====== Yardımcılar ======
    const $ = (q) => document.querySelector(q);
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}); }
    function fmtDate(ts){ const d=new Date(ts); return d.toLocaleDateString('tr-TR',{weekday:'short', day:'2-digit', month:'short'}); }
    function fmtDur(ms){ const s=Math.max(0,Math.round(ms/1000)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return (h? h+" sa ":"") + (m+" dk"); }
    function haversine(a,b){ const R=6371000; const toRad=(x)=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(s)); }
    function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }

    // ====== Depo ======
    const Store = {
      key:'agenda.v1',
      data: { points:[], visits:[], calls:[], notes:[] },
      load(){ try{ const raw=localStorage.getItem(this.key); if(raw){ this.data=JSON.parse(raw); } }catch(e){ console.error(e); }
        renderAll(); },
      save(){ localStorage.setItem(this.key, JSON.stringify(this.data)); }
    };

    // ====== Durum ======
    let watchId = null;
    let currentAnchor = null; // {lat,lon,startedAt,lastAt}
    let lastPoint = null;     // {lat,lon,acc,ts}

    // UI elemanları
    const statusText = $('#statusText');
    const dayText = $('#dayText'); dayText.textContent = fmtDate(Date.now());
    const lastFix = $('#lastFix');
    const lastCoords = $('#lastCoords');
    const visitsList = $('#visitsList');
    const callsList = $('#callsList');
    const notesList = $('#notesList');
    const summaryList = $('#summaryList');

    // ====== Takip ======
    function startTracking(){
      if(!('geolocation' in navigator)){ toast('Konum desteği yok'); return; }
      const optSel = $('#accuracySel').value;
      const options = {
        enableHighAccuracy: optSel==='high',
        maximumAge: optSel==='low'? 120000 : 30000,
        timeout: 20000
      };
      watchId = navigator.geolocation.watchPosition(onPos, onErr, options);
      statusText.textContent = 'Takip Açık';
      $('#toggleBtn').textContent='Durdur';
      toast('Takip başlatıldı');
    }
    function stopTracking(){
      if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      statusText.textContent = 'Hazır';
      $('#toggleBtn').textContent='Takibi Başlat';
      finalizeAnchorIfNeeded(true);
      Store.save();
      renderAll();
      toast('Takip durduruldu');
    }

    function onErr(err){ console.warn(err); toast('Konum alınamadı: '+err.message); }

    function onPos(pos){
      const {latitude:lat, longitude:lon, accuracy} = pos.coords;
      const ts = Date.now();
      if(accuracy>150) return; // düşük kalite ölçümü atla
      const p = {lat,lon,acc:Math.round(accuracy),ts};
      lastFix.textContent = `${fmtDate(ts)} • ${fmtTime(ts)} • ±${p.acc}m`;
      lastCoords.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;

      if(!lastPoint || haversine(lastPoint,p)>15 || (ts-lastPoint.ts)>120000){
        Store.data.points.push(p);
        lastPoint = p;
      }

      const R = Number($('#radiusInp').value || 120);
      const MIN = (Number($('#dwellInp').value || 8))*60*1000;

      if(!currentAnchor){
        currentAnchor = {lat,lon,startedAt:ts,lastAt:ts};
      } else {
        const d = haversine(currentAnchor,{lat,lon});
        if(d<=R){ currentAnchor.lastAt = ts; }
        else { finalizeAnchorIfNeeded(false); currentAnchor = {lat,lon,startedAt:ts,lastAt:ts}; }
      }

      renderSummary();
      Store.save();
    }

    function finalizeAnchorIfNeeded(force){
      if(!currentAnchor) return;
      const MIN = (Number($('#dwellInp').value || 8))*60*1000;
      const dur = currentAnchor.lastAt - currentAnchor.startedAt;
      if(force || dur>=MIN){
        if(dur>=MIN){
          Store.data.visits.push({
            id:'v_'+currentAnchor.startedAt,
            lat: currentAnchor.lat,
            lon: currentAnchor.lon,
            start: currentAnchor.startedAt,
            end: currentAnchor.lastAt,
            notes: []
          });
        }
        currentAnchor=null;
      }
    }

    // ====== Not & Arama ======
    function addQuickNote(text){
      const ts = Date.now();
      const note = { id:'n_'+ts, ts, text };
      const v = nearestVisit(ts);
      if(v && Math.abs((v.end||ts)-ts) < 30*60*1000){ v.notes.push(note); }
      else { Store.data.notes.push(note); }
      Store.save(); renderAll(); toast('Not eklendi');
    }
    function logCall(obj){
      const ts = obj.ts || Date.now();
      Store.data.calls.push({ id:'c_'+ts, ts, who:obj.who, type:obj.type||'gelen', notes:obj.notes||'' });
      Store.save(); renderAll(); toast('Arama kaydedildi');
    }
    function nearestVisit(ts){
      if(Store.data.visits.length===0) return null;
      let best=null, bestDt=1e15;
      for(const v of Store.data.visits){
        const mid = (v.start + (v.end||v.start))/2;
        const dt = Math.abs(ts-mid);
        if(dt<bestDt){ best=v; bestDt=dt; }
      }
      return best;
    }

    // ====== Render ======
    function renderAll(){ renderSummary(); renderVisits(); renderCalls(); renderNotes(); }

    function renderSummary(){
      const S = Store.data;
      summaryList.innerHTML = '';
      const today = todayKey();
      const visitsToday = S.visits.filter(v=> new Date(v.start).toISOString().slice(0,10)===today);
      const callsToday = S.calls.filter(c=> new Date(c.ts).toISOString().slice(0,10)===today);
      const notesToday = S.notes.filter(n=> new Date(n.ts).toISOString().slice(0,10)===today);

      const totalStay = visitsToday.reduce((a,v)=>a+(v.end-v.start),0);
      const items = [
        ['Kalış sayısı', visitsToday.length],
        ['Toplam kalış süresi', fmtDur(totalStay)],
        ['Aramalar', callsToday.length],
        ['Notlar', notesToday.length],
      ];
      for(const [k,v] of items){
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
        summaryList.appendChild(div);
      }
    }

    function renderVisits(){
      visitsList.innerHTML='';
      const visits = [...Store.data.visits].sort((a,b)=>b.start-a.start);
      for(const v of visits){
        const el = document.createElement('div'); el.className='item';
        const dur = fmtDur((v.end||v.start) - v.start);
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="title">Kalış</div>
              <div class="k">${fmtDate(v.start)} • ${fmtTime(v.start)}–${fmtTime(v.end||v.start)} • ${dur}</div>
              <div class="mono">${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}</div>
            </div>
            <div class="row">
              <button data-act="note" class="ok">Not Ekle</button>
              <button data-act="copy" class="ok">Koordinat</button>
              <button data-act="del" class="danger">Sil</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="list">${(v.notes||[]).map(n=>`<div class='item'><div class='k'>${fmtTime(n.ts)}</div><div>${n.text}</div></div>`).join('')}</div>
        `;
        el.querySelector('[data-act="note"]').onclick = ()=>{
          const text = prompt('Not:'); if(text){ v.notes.push({id:'n_'+Date.now(), ts:Date.now(), text}); Store.save(); renderVisits(); toast('Not eklendi'); }
        };
        el.querySelector('[data-act="copy"]').onclick = async ()=>{
          const txt = `${v.lat},${v.lon}`; try{ await navigator.clipboard.writeText(txt); toast('Kopyalandı'); }catch{ toast(txt); }
        };
        el.querySelector('[data-act="del"]').onclick = ()=>{
          if(confirm('Bu kalışı sil?')){ Store.data.visits = Store.data.visits.filter(x=>x.id!==v.id); Store.save(); renderVisits(); }
        };
        visitsList.appendChild(el);
      }
    }

    function renderCalls(){
      callsList.innerHTML='';
      const calls = [...Store.data.calls].sort((a,b)=>b.ts-a.ts);
      for(const c of calls){
        const el=document.createElement('div'); el.className='item';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="title">${c.type==='giden'?'Giden':c.type==='cevapsız'?'Cevapsız':'Gelen'} arama</div>
              <div class="k">${fmtDate(c.ts)} • ${fmtTime(c.ts)}</div>
              <div>${c.who||'Bilinmeyen'}</div>
              ${c.notes? `<div class='hint'>${c.notes}</div>`:''}
            </div>
            <div class="row">
              <button class="ok" data-act="edit">Düzenle</button>
              <button class="danger" data-act="del">Sil</button>
            </div>
          </div>
        `;
        el.querySelector('[data-act="edit"]').onclick = ()=>{
          const who = prompt('Kim?', c.who||'');
          if(who!==null){ c.who=who; const notes = prompt('Not (opsiyonel)', c.notes||''); if(notes!==null) c.notes=notes; Store.save(); renderCalls(); }
        };
        el.querySelector('[data-act="del"]').onclick = ()=>{
          if(confirm('Arama kaydını sil?')){ Store.data.calls = Store.data.calls.filter(x=>x.id!==c.id); Store.save(); renderCalls(); }
        };
        callsList.appendChild(el);
      }
    }

    function renderNotes(){
      notesList.innerHTML='';
      const loose = [...Store.data.notes].sort((a,b)=>b.ts-a.ts);
      for(const n of loose){
        const el=document.createElement('div'); el.className='item';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="title">Not</div>
              <div class="k">${fmtDate(n.ts)} • ${fmtTime(n.ts)}</div>
              <div>${n.text}</div>
            </div>
            <div class="row">
              <button class="ok" data-act="edit">Düzenle</button>
              <button class="danger" data-act="del">Sil</button>
            </div>
          </div>`;
        el.querySelector('[data-act="edit"]').onclick = ()=>{ const text=prompt('Not', n.text); if(text!==null){ n.text=text; Store.save(); renderNotes(); } };
        el.querySelector('[data-act="del"]').onclick = ()=>{ if(confirm('Notu sil?')){ Store.data.notes = Store.data.notes.filter(x=>x.id!==n.id); Store.save(); renderNotes(); } };
        notesList.appendChild(el);
      }
    }

    // ====== UI Bağlantıları ======
    $('#toggleBtn').onclick = ()=> watchId? stopTracking() : startTracking();
    $('#noteBtn').onclick = ()=>{ const t=prompt('Hızlı not:'); if(t) addQuickNote(t); };
    $('#callBtn').onclick = ()=>{
      const who = prompt('Kim aradı / kimi aradın? (isim/numara)'); if(who===null) return;
      const type = prompt('Tür: gelen / giden / cevapsız', 'gelen') || 'gelen';
      const notes = prompt('Not (opsiyonel)', '') || '';
      logCall({who,type,notes});
    };

    $('#exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(Store.data,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ajanda-'+todayKey()+'.json'; a.click();
    };
    $('#importFile').onchange = (e)=>{
      const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const obj=JSON.parse(rd.result); if(obj && obj.visits && obj.calls){ Store.data=obj; Store.save(); renderAll(); toast('İçe aktarıldı'); } }catch{ toast('Hatalı dosya'); } }; rd.readAsText(f);
    };
    $('#clearBtn').onclick = ()=>{ if(confirm('Tüm verileri temizlemek istiyor musun?')){ localStorage.removeItem(Store.key); Store.data={points:[],visits:[],calls:[],notes:[]}; renderAll(); toast('Temizlendi'); } };
    $('#installHint').onclick = ()=>{ alert('iPhone’da Safari ile aç → Paylaş → "Ana Ekrana Ekle". Bu sayede tam ekran ve simge ile çalışır.'); };

    // ====== Service Worker (basit offline önbellek) ======
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('sw.js').catch(console.warn);
      });
    }

    // ====== Başlat ======
    Store.load();
  </script>
</body>
</html>
