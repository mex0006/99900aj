<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0c0f"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <title>Ajanda</title>
  <style>
    /* ===== Reset & Theme ===== */
    :root{
      --bg:#0b0c0f; --panel:#11151b; --ink:#e7ecf2; --muted:#a8b0bd; --edge:#1d2633;
      --tint:#5aa7ff; --ok:#22c55e; --bad:#ef4444; --note:#a78bfa;
      --radius:18px; --tabh:70px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%; background:var(--bg);}
    body{
      margin:0; color:var(--ink);
      font:500 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      min-height:100svh;
      padding-bottom:calc(var(--tabh) + env(safe-area-inset-bottom));
    }
    .container{max-width:980px; margin:0 auto; padding: max(12px, calc(12px + env(safe-area-inset-top))) 12px 0 12px}
    .header{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--edge); border-radius:16px; background:#0f1319; position:sticky; top:0; z-index:20}
    .appname{font-weight:900; letter-spacing:.2px}
    .pill{background:#0e1217; border:1px solid var(--edge); padding:6px 10px; border-radius:999px; color:var(--muted)}
    .title{font-weight:900; letter-spacing:.2px; font-size:clamp(16px, 2.6vw, 18px)}
    .sub{color:var(--muted); font-size:13px}
    .card{background:linear-gradient(180deg,#11151b, #0d1016); border:1px solid var(--edge); border-radius:var(--radius); padding:14px; margin-top:12px}
    .list{display:grid; gap:10px}
    .item{background:#0f1319; border:1px solid var(--edge); border-radius:14px; padding:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn, input, select{appearance:none; border:1px solid var(--edge); background:#0f1319; color:var(--ink); padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#183022,#101a15); border-color:#254232}
    .btn.danger{background:linear-gradient(180deg,#341f1f,#241515); border-color:#3a2626}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#1f2834,transparent); margin:10px 0}
    .dot{width:10px; height:10px; border-radius:50%; background:var(--tint); margin-top:7px}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)} .dot.note{background:var(--note)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; font-size:12px; color:#93a0b3}
    /* Compact month calendar */
    .month{display:grid; gap:8px}
    .month-head{display:flex; align-items:center; justify-content:space-between}
    .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .weekday{color:var(--muted); text-align:center; font-size:12px}
    .d{aspect-ratio:1/1; display:grid; place-items:center; border:1px solid var(--edge); border-radius:12px; background:#0f141c; font-weight:800; cursor:pointer; font-size:14px}
    .d.muted{opacity:.45} .d.sel{outline:2px solid var(--tint); outline-offset:-3px} .d.today{border-color:#2a3a52}
    /* Timeline */
    .timeline .event{display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start}
    .timeline .event .h{font-weight:800}
    .empty{color:var(--muted); text-align:center; padding:16px}
    /* Map */
    #map{height:calc(60vh); border-radius:14px; overflow:hidden; border:1px solid var(--edge);}
    .legend{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}
    .chip{width:10px; height:10px; border-radius:50%} .chip.route{background:var(--tint)} .chip.visit{background:var(--ok)}
    /* Bottom Tab Bar */
    .tabbar{
      position:fixed; left:0; right:0; bottom:0;
      height:var(--tabh);
      padding-bottom:env(safe-area-inset-bottom);
      background:#0f1319; border-top:1px solid var(--edge);
      display:grid; grid-template-columns:repeat(5,1fr);
      z-index:50;
    }
    .tabbtn{display:grid; place-items:center; gap:4px; color:var(--muted); font-size:12px; text-decoration:none}
    .tabbtn .ico{font-size:20px}
    .tabbtn.active{color:var(--ink)}
    /* pages */
    .page{display:none}
    .page.active{display:block}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="appname">Ajanda</div>
      <div class="pill">Gün: <b id="dayText">—</b></div>
      <div class="pill">Durum: <b id="statusText">Hazır</b></div>
      <div style="margin-left:auto" class="row">
        <button id="exportBtn" class="btn">CSV</button>
        <label for="importFile" class="btn" style="cursor:pointer">İçe Aktar</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
      </div>
    </div>

    <!-- Timeline Page -->
    <div id="pg-timeline" class="page active">
      <section class="card">
        <div class="month">
          <div class="month-head">
            <button class="btn" id="prevMonth">‹</button>
            <div class="title" id="calTitle">—</div>
            <button class="btn" id="nextMonth">›</button>
          </div>
          <div class="grid" id="calWeekdays"></div>
          <div class="grid" id="calGrid"></div>
        </div>
      </section>
      <section class="card">
        <div class="title">Günün Zaman Çizelgesi</div>
        <div class="list timeline" id="timelineList"></div>
      </section>
      <section class="card">
        <div class="title">Konum Takibi</div>
        <div class="sub">Uygulama açıkken konumunu izler ve kalışları oluşturur.</div>
        <div class="hr"></div>
        <div class="list" style="grid-template-columns:1fr 1fr; display:grid">
          <div class="item">
            <div class="sub">Son Konum</div>
            <div class="title" id="lastFix">—</div>
            <div class="sub" id="lastAddr">—</div>
            <div class="mono" id="lastCoords"></div>
          </div>
          <div class="item">
            <div class="sub">Takip</div>
            <div class="row">
              <button id="toggleBtn" class="btn primary">Takibi Başlat</button>
              <select id="accuracySel" class="btn">
                <option value="balanced">Dengeli</option>
                <option value="high">Yüksek</option>
                <option value="low">Düşük</option>
              </select>
            </div>
            <div class="sub" id="wakeInfo"></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Map Page -->
    <div id="pg-map" class="page">
      <section class="card">
        <div class="title">Harita</div>
        <div class="sub">Günün hareketleri ve kalış noktaları</div>
        <div class="hr"></div>
        <div id="map"></div>
        <div class="hr"></div>
        <div class="legend"><span class="chip route"></span> Güzergâh &nbsp; <span class="chip visit"></span> Kalış</div>
      </section>
    </div>

    <!-- Add Page (Quick) -->
    <div id="pg-add" class="page">
      <section class="card">
        <div class="title">Hızlı Ekle</div>
        <div class="hr"></div>
        <div class="row">
          <button id="noteBtn" class="btn">Not</button>
          <button id="callBtn" class="btn">Arama</button>
          <button id="wakeBtn" class="btn">Ekranı Açık Tut</button>
        </div>
      </section>
      <section class="card">
        <div class="title">Ayarlar (Kısa)</div>
        <div class="sub">Kalış Algılama</div>
        <div>Yarıçap <input id="radiusInp" class="btn" type="number" min="30" max="300" step="10" value="120" style="width:90px"> m ·
          Eşik <input id="dwellInp" class="btn" type="number" min="1" max="60" step="1" value="8" style="width:70px"> dk</div>
      </section>
    </div>

    <!-- Search Page -->
    <div id="pg-search" class="page">
      <section class="card">
        <div class="title">Arama & Filtre</div>
        <div class="row">
          <input id="q" class="btn" placeholder="kelime, kişi...">
          <select id="typeSel" class="btn">
            <option value="">Tümü</option>
            <option value="visit">Kalış</option>
            <option value="call">Arama</option>
            <option value="note">Not</option>
          </select>
          <button id="searchBtn" class="btn">Ara</button>
        </div>
        <div class="hr"></div>
        <div class="list" id="searchResults"></div>
      </section>
    </div>

    <!-- Settings Page -->
    <div id="pg-settings" class="page">
      <section class="card">
        <div class="title">Veri</div>
        <div class="row">
          <label for="importFile" class="btn" style="cursor:pointer">İçe Aktar</label>
          <button id="clearBtn" class="btn danger">Temizle</button>
        </div>
      </section>
    </div>

  </div>

  <!-- Bottom Tabs -->
  <nav class="tabbar">
    <a class="tabbtn active" data-tab="timeline"><div class="ico">🗓️</div><div>Zaman</div></a>
    <a class="tabbtn" data-tab="map"><div class="ico">🗺️</div><div>Harita</div></a>
    <a class="tabbtn" data-tab="add"><div class="ico">➕</div><div>Ekle</div></a>
    <a class="tabbtn" data-tab="search"><div class="ico">🔎</div><div>Arama</div></a>
    <a class="tabbtn" data-tab="settings"><div class="ico">⚙️</div><div>Ayarlar</div></a>
  </nav>

  <!-- Permission overlay -->
  <div id="permOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center; padding:20px">
    <div style="max-width:540px; width:100%; background:#11151b; border:1px solid var(--edge); border-radius:20px; padding:16px">
      <div class="title">Konum izni gerekiyor</div>
      <div class="sub" style="margin:6px 0 12px 0">Safari için “aA → Site Ayarları → Konum: İzin ver”. PWA ise Ayarlar → Konum Servisleri.</div>
      <div style="display:flex; justify-content:flex-end"><button class="btn" id="permOverlayClose">Tamam</button></div>
    </div>
  </div>

  <script>
    /* ===== Navigation ===== */
    const tabs = document.querySelectorAll('.tabbtn');
    const pages = {
      timeline: document.getElementById('pg-timeline'),
      map: document.getElementById('pg-map'),
      add: document.getElementById('pg-add'),
      search: document.getElementById('pg-search'),
      settings: document.getElementById('pg-settings')
    };
    function showTab(name){
      Object.values(pages).forEach(p=> p.classList.remove('active'));
      pages['pg-'+name] && pages['pg-'+name].classList.add('active'); // not used
      (pages[name]||pages.timeline).classList.add('active');
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
      if(name==='map') setTimeout(initMapOnce, 50);
      if(name==='map') setTimeout(updateMap, 80);
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> showTab(t.dataset.tab)));
    // init default
    showTab('timeline');

    /* ===== Utilities ===== */
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>Array.from(document.querySelectorAll(q));
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}); }
    function fmtDateShort(ts){ const d=new Date(ts); return d.toLocaleDateString('tr-TR',{weekday:'short', day:'2-digit', month:'short'}); }
    const dateKey=(ts)=> new Date(ts).toISOString().slice(0,10);
    const todayKey=()=> dateKey(Date.now());
    const startOfDay=(ts)=>{ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); };
    const endOfDay=(ts)=>{ const d=new Date(ts); d.setHours(23,59,59,999); return d.getTime(); };
    function haversine(a,b){ const R=6371000; const toRad=(x)=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(s)); }

    /* ===== Store (localStorage) ===== */
    const Store = {
      key:'agenda.v5',
      data:{ points:[], visits:[], calls:[], notes:[], addrCache:{} },
      load(){ try{ const raw=localStorage.getItem(this.key); if(raw){ this.data=JSON.parse(raw); } }catch{} renderAll(); },
      save(){ localStorage.setItem(this.key, JSON.stringify(this.data)); }
    };

    /* ===== State ===== */
    let watchId=null, currentAnchor=null, lastPoint=null, wakeLock=null;
    let selectedDay=todayKey();
    $('#dayText').textContent = fmtDateShort(Date.now());
    const statusText=$('#statusText'), lastFix=$('#lastFix'), lastAddr=$('#lastAddr'), lastCoords=$('#lastCoords');

    /* ===== Calendar ===== */
    const weekdays=['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
    function buildWeekdays(){ const root=$('#calWeekdays'); root.innerHTML=''; for(const w of weekdays){ const d=document.createElement('div'); d.className='weekday'; d.textContent=w; root.appendChild(d);}}
    function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function firstWeekday(y,m){ const d=new Date(y,m,1).getDay(); return (d+6)%7; }
    let calYear=new Date().getFullYear(), calMonth=new Date().getMonth();
    function renderCalendar(){
      $('#calTitle').textContent = new Date(calYear, calMonth, 1).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
      const grid=$('#calGrid'); grid.innerHTML='';
      const days=daysInMonth(calYear,calMonth), offset=firstWeekday(calYear,calMonth), prevDays=daysInMonth(calYear,calMonth-1);
      for(let i=0;i<offset;i++) grid.appendChild(dayCell(prevDays-offset+i+1,true));
      for(let d=1; d<=days; d++) grid.appendChild(dayCell(d,false));
      const cellsNeeded=42-(offset+days); for(let d=1; d<=cellsNeeded; d++) grid.appendChild(dayCell(d,true,true));
      highlightSelected();
    }
    function dayCell(day, muted, next=false){
      const div=document.createElement('div'); div.className='d'+(muted?' muted':'');
      div.textContent=day;
      let y=calYear, m=calMonth;
      if(muted && !next){ m--; if(m<0){ m=11; y--; } }
      if(muted && next){ m++; if(m>11){ m=0; y++; } }
      const key=`${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      if(key===todayKey()) div.classList.add('today');
      div.dataset.key=key;
      div.onclick=()=>{ selectedDay=key; $('#dayText').textContent=new Date(key).toLocaleDateString('tr-TR',{weekday:'short',day:'2-digit',month:'short'}); highlightSelected(); renderAll(); showTab('timeline'); };
      return div;
    }
    function highlightSelected(){ $$('#calGrid .d').forEach(el=> el.classList.toggle('sel', el.dataset.key===selectedDay)); }
    $('#prevMonth').onclick=()=>{ calMonth--; if(calMonth<0){calMonth=11; calYear--;} renderCalendar(); };
    $('#nextMonth').onclick=()=>{ calMonth++; if(calMonth>11){calMonth=0; calYear++;} renderCalendar(); };
    buildWeekdays(); renderCalendar();

    /* ===== Reverse Geocoding (OSM) ===== */
    async function reverseGeocode(lat, lon){
      const key = lat.toFixed(5)+','+lon.toFixed(5); if(Store.data.addrCache[key]) return Store.data.addrCache[key];
      try{ const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=tr`; const res=await fetch(url,{headers:{'Accept':'application/json','User-Agent':'AjandaPWA/1.0'}}); const j=await res.json(); const a=j.address||{}; const parts=[[a.road,a.house_number].filter(Boolean).join(' '), a.neighbourhood||a.suburb||a.district||a.borough, a.town||a.city||a.county, a.state].filter(Boolean); const s=parts.join(', '); Store.data.addrCache[key]=s||j.display_name||key; Store.save(); return Store.data.addrCache[key]; } catch{ return key; }
    }

    /* ===== Tracking ===== */
    function requestOneShotPermission(){ return new Promise((resolve,reject)=>{ if(!('geolocation' in navigator)) return reject(new Error('konum yok')); navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy:true, timeout:10000, maximumAge:0}); }); }
    async function startTracking(){
      try{ await requestOneShotPermission(); }catch(e){ if(e.code===1) $('#permOverlay').style.display='flex'; return; }
      const optSel=$('#accuracySel').value; const options={ enableHighAccuracy: optSel==='high', maximumAge: optSel==='low'?120000:30000, timeout:20000 };
      watchId = navigator.geolocation.watchPosition(onPos, onErr, options);
      statusText.textContent='Takip Açık'; $('#toggleBtn').textContent='Durdur';
    }
    function stopTracking(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } statusText.textContent='Hazır'; $('#toggleBtn').textContent='Takibi Başlat'; finalizeAnchorIfNeeded(true); Store.save(); renderAll(); }
    function onErr(err){ if(err && err.code===1) $('#permOverlay').style.display='flex'; }
    async function onPos(pos){
      const {latitude:lat, longitude:lon, accuracy} = pos.coords; const ts=Date.now(); if(accuracy>150) return;
      const p={lat,lon,acc:Math.round(accuracy),ts}; lastFix.textContent=`${fmtDateShort(ts)} • ${fmtTime(ts)} • ±${p.acc}m`; lastCoords.textContent=`${lat.toFixed(5)}, ${lon.toFixed(5)}`; lastAddr.textContent='adres aranıyor…'; reverseGeocode(lat,lon).then(s=> lastAddr.textContent=s);
      if(!lastPoint || haversine(lastPoint,p)>15 || (ts-lastPoint.ts)>120000){ Store.data.points.push(p); lastPoint=p; }
      const R=Number($('#radiusInp').value||120), MIN=(Number($('#dwellInp').value||8))*60*1000;
      if(!currentAnchor){ currentAnchor={lat,lon,startedAt:ts,lastAt:ts}; } else { const d=haversine(currentAnchor,{lat,lon}); if(d<=R){ currentAnchor.lastAt=ts; } else { finalizeAnchorIfNeeded(false); currentAnchor={lat,lon,startedAt:ts,lastAt:ts}; } }
      Store.save(); renderAll();
    }
    function finalizeAnchorIfNeeded(force){
      if(!currentAnchor) return; const MIN=(Number($('#dwellInp').value||8))*60*1000; const dur=currentAnchor.lastAt - currentAnchor.startedAt;
      if(force || dur>=MIN){ if(dur>=MIN){ Store.data.visits.push({ id:'v_'+currentAnchor.startedAt, lat:currentAnchor.lat, lon:currentAnchor.lon, start:currentAnchor.startedAt, end:currentAnchor.lastAt }); } currentAnchor=null; }
    }

    /* ===== Wake Lock ===== */
    async function requestWake(){ if('wakeLock' in navigator){ try{ wakeLock = await navigator.wakeLock.request('screen'); $('#wakeInfo').textContent='Ekran uyanık tutuluyor'; wakeLock.addEventListener('release',()=> $('#wakeInfo').textContent=''); }catch(e){ $('#wakeInfo').textContent='Wake Lock reddedildi'; } } else { $('#wakeInfo').textContent='Wake Lock yok'; } }
    $('#wakeBtn').onclick = requestWake;

    /* ===== Add buttons ===== */
    $('#noteBtn').onclick=()=>{ const t=prompt('Not:'); if(!t) return; const ts=Date.now(); Store.data.notes.push({id:'n_'+ts, ts, text:t}); Store.save(); renderAll(); };
    $('#callBtn').onclick=()=>{ const who=prompt('Kim?'); if(who===null) return; const type=prompt('Tür: gelen / giden / cevapsız', 'gelen')||'gelen'; const notes=prompt('Not (opsiyonel)','')||''; const ts=Date.now(); Store.data.calls.push({id:'c_'+ts, ts, who, type, notes}); Store.save(); renderAll(); };

    /* ===== Timeline Render ===== */
    function renderAll(){ renderTimeline(); if(mapInited) updateMap(); }
    function renderTimeline(){
      const tl=$('#timelineList'); tl.innerHTML='';
      const dayTS = new Date(selectedDay+'T00:00:00').getTime();
      const from = startOfDay(dayTS), to=endOfDay(dayTS);
      const events=[];
      for(const v of Store.data.visits){ if(v.end<from || v.start>to) continue; events.push({ts:v.start, sort:v.start, type:'visit', lat:v.lat, lon:v.lon, dur:((v.end-v.start)/60000|0)}); }
      for(const n of Store.data.notes){ if(n.ts>=from && n.ts<=to) events.push({ts:n.ts, sort:n.ts+0.1, type:'note', text:n.text}); }
      for(const c of Store.data.calls){ if(c.ts>=from && c.ts<=to) events.push({ts:c.ts, sort:c.ts+0.2, type:'call', who:c.who, callType:c.type, notes:c.notes}); }
      events.sort((a,b)=> a.sort-b.sort);
      if(events.length===0){ const empty=document.createElement('div'); empty.className='item'; empty.innerHTML='<div class="sub">Bu gün için kayıt yok.</div>'; tl.appendChild(empty); return; }
      for(const ev of events){
        const el=document.createElement('div'); el.className='item event';
        const dotClass = ev.type==='visit'?'ok': ev.type==='call'?(ev.callType==='cevapsız'?'bad':'') : 'note';
        el.innerHTML = `<div class="dot ${dotClass}"></div><div><div class="h">${fmtTime(ev.ts)} — ${label(ev)}</div><div class="sub">${sub(ev)}</div></div>`;
        tl.appendChild(el);
        if(ev.type==='visit'){ (async()=>{ const addr = await reverseGeocode(ev.lat, ev.lon); el.querySelector('.sub').textContent = `${addr} • ${Math.max(1, ev.dur)} dk`; })(); }
      }
      function label(ev){ if(ev.type==='visit') return 'Kalış'; if(ev.type==='call') return (ev.callType==='giden'?'Giden':ev.callType==='cevapsız'?'Cevapsız':'Gelen')+' arama'; return 'Not'; }
      function sub(ev){ if(ev.type==='note') return ev.text; if(ev.type==='call') return [ev.who||'Bilinmeyen', ev.notes||''].filter(Boolean).join(' • '); return 'adres alınıyor…'; }
    }

    /* ===== Map (Leaflet) ===== */
    let map, mapInited=false, routeLayer, visitLayer;
    function initMapOnce(){ if(mapInited) return; mapInited=true; map=L.map('map',{zoomControl:true}).setView([39.93,32.86], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
      routeLayer=L.polyline([], {color:'#5aa7ff', weight:3, opacity:0.85}).addTo(map);
      visitLayer=L.layerGroup().addTo(map);
      updateMap();
    }
    function updateMap(){
      if(!mapInited) return;
      const dayTS = new Date(selectedDay+'T00:00:00').getTime(); const from=startOfDay(dayTS), to=endOfDay(dayTS);
      const pts=(Store.data.points||[]).filter(p=> p.ts>=from && p.ts<=to);
      const vs=(Store.data.visits||[]).filter(v=> (v.end>=from && v.start<=to));
      routeLayer.setLatLngs(pts.map(p=>[p.lat,p.lon]));
      visitLayer.clearLayers();
      const bounds=[];
      for(const p of pts){ bounds.push([p.lat,p.lon]); }
      for(const v of vs){ const m=L.circleMarker([v.lat,v.lon],{radius:6,color:'#22c55e',fill:true,fillOpacity:.95}).addTo(visitLayer); m.bindPopup('Kalış • '+new Date(v.start).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})+' — '+new Date(v.end).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})); bounds.push([v.lat,v.lon]); }
      // Fit to available data (visits or points). If none, keep last point
      if(bounds.length){ map.fitBounds(bounds, {padding:[20,20]}); }
      else if(lastPoint){ map.setView([lastPoint.lat,lastPoint.lon], 14); }
    }

    /* ===== Search ===== */
    $('#searchBtn').onclick = ()=>{
      const q=$('#q').value.trim().toLowerCase(); const type=$('#typeSel').value; const out=$('#searchResults'); out.innerHTML='';
      function push(label, sub){ const el=document.createElement('div'); el.className='item'; el.innerHTML=`<div class="title">${label}</div><div class="sub">${sub}</div>`; out.appendChild(el); }
      for(const v of Store.data.visits){ if(type && type!=='visit') continue; const addrKey=(v.lat.toFixed(5)+','+v.lon.toFixed(5)); const addr=Store.data.addrCache[addrKey]||''; const text=addr.toLowerCase(); if(!q || text.includes(q)) push('Kalış — '+new Date(v.start).toLocaleDateString('tr-TR'), addr); }
      for(const c of Store.data.calls){ if(type && type!=='call') continue; const text=((c.who||'')+' '+(c.notes||'')).toLowerCase(); if(!q || text.includes(q)) push((c.type==='giden'?'Giden':c.type==='cevapsız'?'Cevapsız':'Gelen')+' arama — '+new Date(c.ts).toLocaleDateString('tr-TR'), (c.who||'Bilinmeyen')+(c.notes?' • '+c.notes:'')); }
      for(const n of Store.data.notes){ if(type && type!=='note') continue; const text=(n.text||'').toLowerCase(); if(!q || text.includes(q)) push('Not — '+new Date(n.ts).toLocaleDateString('tr-TR'), n.text); }
      if(!out.children.length) out.innerHTML='<div class="sub">Sonuç yok</div>';
    };

    /* ===== Export ===== */
    function exportCSVDay(){
      const day=selectedDay; const from=startOfDay(new Date(day).getTime()), to=endOfDay(new Date(day).getTime());
      const rows=[['time','type','title','details']];
      function addRow(t,ty,title,det){ rows.push([new Date(t).toISOString(), ty, title, det.replaceAll(',',';')]); }
      for(const v of Store.data.visits){ if(v.end<from||v.start>to) continue; addRow(v.start,'visit','Kalış', `${v.lat},${v.lon}`); }
      for(const c of Store.data.calls){ if(c.ts<from||c.ts>to) continue; addRow(c.ts,'call',c.type,(c.who||'')+' '+(c.notes||'')); }
      for(const n of Store.data.notes){ if(n.ts<from||n.ts>to) continue; addRow(n.ts,'note','Not', n.text||''); }
      const csv = rows.map(r=> r.map(x=> `"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ajanda-${day}.csv`; a.click();
    }
    document.getElementById('exportBtn').onclick = exportCSVDay;

    /* ===== Import/Clear ===== */
    document.getElementById('importFile').onchange = (e)=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const obj=JSON.parse(rd.result); if(obj && obj.visits && obj.calls){ Store.data=obj; Store.save(); renderAll(); } }catch{ alert('Hatalı dosya'); } }; rd.readAsText(f); };
    document.getElementById('clearBtn').onclick = ()=>{ if(confirm('Tüm verileri sil?')){ localStorage.removeItem(Store.key); Store.data={ points:[], visits:[], calls:[], notes:[], addrCache:{} }; renderAll(); } };

    /* ===== Buttons ===== */
    document.getElementById('toggleBtn').onclick = ()=> watchId ? stopTracking() : startTracking();
    document.getElementById('permOverlayClose').onclick = ()=>{ document.getElementById('permOverlay').style.display='none'; };

    /* ===== Init ===== */
    Store.load();
  </script>
</body>
</html>
